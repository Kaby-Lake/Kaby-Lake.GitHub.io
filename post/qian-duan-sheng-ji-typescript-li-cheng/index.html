<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å‰ç«¯å‡çº§TypeScriptå†ç¨‹ | Gridea</title>
<link rel="shortcut icon" href="https://kaby-lake.github.io//favicon.ico?v=1629027737869">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://kaby-lake.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="å‰ç«¯å‡çº§TypeScriptå†ç¨‹ | Gridea - Atom Feed" href="https://kaby-lake.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="


ä¸­é—´ä»¶
åœ¨æ”¹å†™ä¸­é—´ä»¶ä¸ºtsçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›éº»çƒ¦ï¼Œä¹Ÿåæ˜ å‡ºäº†tsåº”ç”¨åœ¨å¤§é¡¹ç›®å½“ä¸­ä¸å¤Ÿçµæ´»çš„é—®é¢˜ã€‚ä»¥ç™»å½•æ£€æµ‹ä¸­é—´ä»¶ä¸ºä¾‹ï¼šå½“ç”¨æˆ·é€šè¿‡äº†oaç™»å½•åï¼Œå®ƒä¼šæŠŠç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯æ³¨å†Œåˆ°ctx.reqé‡Œé¢ã€‚jsçš„è¯ç›´æ¥æ”¾è¿›å»å°±å¥½äº†ï¼Œä½†tsä¼šæç¤ºä½ ä»–ä¸..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://kaby-lake.github.io/">
  <img class="avatar" src="https://kaby-lake.github.io//images/avatar.png?v=1629027737869" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              å‰ç«¯å‡çº§TypeScriptå†ç¨‹
            </h2>
            <div class="post-info">
              <span>
                2021-08-15
              </span>
              <span>
                10 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <!--å› ä¸ºä¸ªäººååˆ†å–œæ¬¢å¼ºç±»å‹çš„è¯­è¨€ï¼Œå› æ­¤çœ‹åˆ°çº¯JSçš„å¼±ç±»å‹å’Œç¨€çƒ‚çš„ç±»å‹æ¨æ–­æ”¯æŒå°±å¾ˆæ¼ç«ï¼Œè€Œä¸”ç¨å¾®ä¸æ³¨æ„å°±ä¼šå¼•å…¥å¾ˆå¤šruntime errorï¼Œè€Œå¦‚æœè½¬å‘TypeScriptå°±å¯ä»¥åœ¨ç¼–è¯‘æœŸæœç»ç»å¤§å¤šæ•°çš„ `cannot read property of undefined`ã€‚å› æ­¤è¯•ç€æŠŠå‰ç«¯çš„é¡¹ç›®ï¼ˆä¿¡å®‰ä¸­å°ï¼‰æä¾›TypeScriptã€‚è¿™é‡Œè®°å½•äº†ä¸€äº›é‡åˆ°çš„é—®é¢˜å’Œå°è¯•çš„è§£å†³æ–¹æ¡ˆã€‚-->
<!--å‡çº§ç°æœ‰é¡¹ç›®çš„å‰æå°±æ˜¯ä¸è¦å¤§åŠ¨æ¶æ„å’Œé€»è¾‘ï¼Œè€ŒåƒæŠŠæœ€é¡¶å±‚çš„server.jsã€next.configç­‰æ–‡ä»¶æ”¹æˆtsçš„è¯ä¼šå¤§å¹…å¢åŠ ç¬¬ä¸€æ—¶é—´ç¼–è¯‘çš„è´Ÿæ‹…ï¼Œè€Œä¸”è¿™ä¸æ˜¯nextæ¨èçš„æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬å°½å¯èƒ½çš„ä¿ç•™åŸæ¥çš„é…ç½®æ–‡ä»¶ï¼Œè€Œæ›´å…³æ³¨å…·ä½“åŠŸèƒ½çš„å®ç°ã€‚-->
<!--åªæœ‰å†…éƒ¨çš„å¸¸ç”¨å·¥å…·åŒ…éƒ½é™„å¸¦äº†å£°æ˜æ–‡ä»¶ï¼Œé¡¹ç›®ç”¨tsæ‰æœ‰æ„ä¹‰ï¼Œå› æ­¤ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å…ˆè®©ç°æœ‰çš„ä¸€äº›å¸¸ç”¨ä¸­é—´ä»¶éƒ½æœ‰tsç‰ˆæœ¬ã€‚æˆ‘æŒ‘äº†ä¸€äº›ä¸­å°å¸¸ç”¨çš„æ¯”å¦‚è¯´ `@sgoc/oa-login-checker-ts"` `@sgoc/sigma-httpfetch-ts` `@sgoc/super-permission-checker-ts` `@sgoc/logger-ts`ç­‰éƒ½æ·»åŠ äº†tsæ”¯æŒï¼ˆåœ¨å¯¹åº”åŒ…åå­—åé¢æ·»åŠ äº†-tsï¼‰ï¼Œå¹¶ä¸”exporté‡Œå¢åŠ äº†è¿™ä¸ªä¸­é—´ä»¶å¯èƒ½ä¼šåœ¨Koa Contextä¸­æ–°å¢ä»€ä¹ˆå†…å®¹çš„interfaceï¼Œå¯ä»¥ç”¨åœ¨Koaå’ŒNextçš„æ³›å‹ä¸­ã€‚-->
<h4 id="ä¸­é—´ä»¶">ä¸­é—´ä»¶</h4>
<p>åœ¨æ”¹å†™ä¸­é—´ä»¶ä¸ºtsçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›éº»çƒ¦ï¼Œä¹Ÿåæ˜ å‡ºäº†tsåº”ç”¨åœ¨å¤§é¡¹ç›®å½“ä¸­ä¸å¤Ÿçµæ´»çš„é—®é¢˜ã€‚ä»¥ç™»å½•æ£€æµ‹ä¸­é—´ä»¶ä¸ºä¾‹ï¼šå½“ç”¨æˆ·é€šè¿‡äº†oaç™»å½•åï¼Œå®ƒä¼šæŠŠç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯æ³¨å†Œåˆ°ctx.reqé‡Œé¢ã€‚jsçš„è¯ç›´æ¥æ”¾è¿›å»å°±å¥½äº†ï¼Œä½†tsä¼šæç¤ºä½ ä»–ä¸è§‰å¾—reqé‡Œé¢æœ‰ä½ è¦æ·»åŠ çš„å±æ€§ï¼Œä»–åªçŸ¥é“reqæ˜¯ä¸€ä¸ªIncomingMessageç±»å‹ï¼Œä½ åªå¯ä»¥è®¿é—®æˆ–è€…ä¿®æ”¹ä»–çŸ¥é“çš„è¿™é‡Œé¢å­˜åœ¨çš„ä¸œè¥¿ï¼ˆæ˜¯ä¸æ˜¯å¾ˆjavağŸ˜…ï¼‰ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜å°±è¦å¼•å…¥æ³›å‹ï¼ˆGenericsï¼‰æˆ–è€…æ¨¡å—å¢å¼ºï¼ˆModule Augmentationï¼‰ä¸¤ç§æ–¹æ¡ˆã€‚</p>
<p>æœ€åæˆ‘é€‰æ‹©çš„æ˜¯æ³›å‹ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-typescript">type IOaLoginIncomingMessage = {
    oaUserInfo: {
        isLogin: boolean,
        loginUser: ILoginUser | null,
    }
}

function checkToLoginIfNoUser(): Middleware&lt;{}, { req: IOaLoginIncomingMessage }&gt; {
  return async function (ctx, next) {
  	// è¿™é‡Œé¢å°±å¯ä»¥å¯¹ctx.req.oaUserInfoè¿›è¡Œèµ‹å€¼ç­‰æ“ä½œ
  }
}
</code></pre>
<p>å¦‚æœæ³¨å†Œæ­¤ä¸­é—´ä»¶åœ¨äº†Koa Serverä¸Šé¢ï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ªæ³›å‹ä¹Ÿä¼ ç»™Koa Serverã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ¨¡å—å¢å¼ºè€Œé€‰æ‹©ä¸é‚£ä¹ˆæ–¹ä¾¿çš„æ³›å‹ï¼Ÿ</p>
</blockquote>
<p>è¿™æ˜¯TypeScriptçš„ä¸€ä¸ªé™åˆ¶ï¼Œæ¨¡å—å¢å¼ºä»…èƒ½ç»™ç°æœ‰æ¨¡å—é‡Œçš„ç‰¹å®šæ¥å£ï¼ˆæ¯”å¦‚Koaä¸­çš„IncomingMessageï¼‰<strong>å¢åŠ å±æ€§</strong>ï¼Œè€Œä¸èƒ½<strong>ä¿®æ”¹å±æ€§</strong>ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæŒ‰ç…§ä¿¡å®‰ä¸­å°çš„é€»è¾‘ï¼Œé¦–å…ˆè°ƒç”¨<code>oa-login-checker</code>è¿™ä¸ªåŒ…ï¼Œå®ƒä¼šåœ¨ctx.reqé‡Œå¢åŠ oaUserInfoï¼Œå®ƒçš„ç±»å‹å¯è§ä¸Šã€‚</p>
<p>æ¥ä¸‹æ¥ä¼šè°ƒ<code>super-permission-checker</code>è¿™ä¸ªä¸­é—´ä»¶ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ£€æµ‹è¿™ä¸ªuseræ˜¯ä¸æ˜¯superï¼Œå¦‚æœæ˜¯çš„è¯åœ¨åˆšæ·»åŠ çš„oaUserInfoä¸­å†æ·»åŠ ä¸€ä¸ªï¼š</p>
<pre><code class="language-typescript">inPasList: {
    [key: string]: boolean;
};
</code></pre>
<p>è¿™æ ·çš„å±æ€§ã€‚å¦‚æœç”¨æ¨¡å—å¢å¼ºï¼Œè¯­æ³•æ˜¯è¿™æ ·çš„ï¼ˆctx.reqçš„ç±»å‹æ˜¯IncomingMessageï¼‰</p>
<pre><code class="language-typescript">declare module &quot;koa&quot; {
    interface IncomingMessage {
        oaUserInfo: {
          ...
        }
    }
}
</code></pre>
<p>å½“æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨æ¨¡å—å¢å¼ºæ—¶ï¼Œè¿™ä¸¤ä¸ªåŒ…åˆ†åˆ«éƒ½è¦ç»™Koa.IncomingMessageå¢å¼ºä¸€æ¬¡ã€‚è¿™ä¸ªæ—¶å€™tsc(TypeScript Compiler)å°±ä¼šå‘Šè¯‰æˆ‘ä»¬è¯´â€Subsequent property declarations must have the same typeâ€œï¼Œæ„æ€æ˜¯ä½ åˆšåˆšå®šä¹‰çš„oaUserInfoåªå¯ä»¥åœ¨ç¬¬ä¸€æ¬¡å¢åŠ çš„æ—¶å€™å°±æ•²å®šäº†ç±»å‹ï¼ˆé‡Œé¢æ²¡æœ‰inPasListï¼‰ï¼Œè€Œä¸å¯ä»¥åœ¨åç»­å†åœ¨é‡Œé¢å¢åŠ å±æ€§ã€‚æˆ‘å»æŸ¥äº†tsçš„handbookï¼Œå‘ç°æ˜ç¡®æŒ‡å‡ºäº†â€you can't declare new top-level declarations in the augmentation -- just patches to existing declarations.â€œ ã€‚</p>
<p>å¾ˆä¸å¹¸çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰çš„åŒ…å®šä¹‰éƒ½ç»™äº†æ³›å‹å¯ä»¥ä¼ ã€‚æ¯”å¦‚åœ¨æ”¹Loggerä¸­é—´ä»¶çš„æ—¶å€™ï¼Œæœ‰æ—¶éœ€è¦åœ¨Errorè¿™ä¸ªå¯¹è±¡ä¸Šé¢å¢åŠ ä¸€äº›è‡ªå®šä¹‰å±æ€§ï¼Œè¿™æ—¶å€™å°±åªèƒ½ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢äº†ï¼ˆå‰ææ˜¯ä½ å¾ˆç¡®å®šè¿™æ ·è½¬æ˜¯æ²¡é—®é¢˜çš„ï¼‰ã€‚</p>
<pre><code class="language-typescript">export interface CustomizedError extends Error {
    type?: string
    errorType?: string
}

let err = &lt;CustomizedError&gt;new Error();
err.type = &quot;unhandledRejection&quot;;
</code></pre>
<h4 id="next-koa">Next &amp; Koa</h4>
<h5 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h5>
<p>è¿™ä¸ªé¡¹ç›®çš„é€»è¾‘æ˜¯ï¼Œç”¨Koaè¿›è¡Œä¸­é—´ä»¶å’ŒApiè·¯ç”±ï¼Œç”¨Nextè¿›è¡ŒReact SSRæ¸²æŸ“ã€‚å› æ­¤ï¼Œå°±è¦å°†ctxä¹Ÿä¼ ç»™Nextã€‚å¾ˆå¥‡æ€ªçš„æ˜¯ï¼ŒIncomingMessageå’ŒServerResponseè¿™ä¿©interfaceåœ¨é¡¹ç›®æŒ‡å®šç‰ˆæœ¬çš„koaå’Œnextä¸­å®šä¹‰æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™æ ·å¦‚æœç›´æ¥ä¼ çš„è¯å°±ä¼šæŠ¥é”™ï¼ˆtsè§‰å¾—ç±»å‹ä¸ä¸€æ ·ï¼‰ã€‚ç»è¿‡ä¸€ç•ªç ”ç©¶ï¼Œå‘ç°æ–°ç‰ˆçš„koaå’Œnextçš„d.tsè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå‡çº§å³å¯ã€‚</p>
<h5 id="dev">dev</h5>
<p>è€Œåœ¨å¯åŠ¨devå‘½ä»¤çš„æ—¶å€™ï¼Œå› ä¸ºtsè¦ç»è¿‡ä¸€å±‚ç¼–è¯‘ä»¥åæ‰èƒ½ç”Ÿæˆå¯¹åº”çš„/nextæ–‡ä»¶å¤¹ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ts-nodeæ¥è·‘index.tså»å¯åŠ¨koa serverï¼Œpackage.jsonä¸­å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">rm -rf .next/ &amp;&amp; NODE_ENV=dev nodemon -w server --exec 'ts-node' server.ts
</code></pre>
<h5 id="before-render">Before Render</h5>
<p>æœ‰æ—¶å€™æˆ‘ä»¬åœ¨æŠŠctxäº¤ç»™Koaè¿›è¡Œrenderä¹‹å‰ï¼Œè¿˜æƒ³å†å¾€ctxé‡Œé¢æ”¾ä¸€äº›ä¸œè¥¿ï¼ˆæ¯”å¦‚å¯¹äºlisté¡µé¢å°±ä¼šæœ‰req.dimè¿™ç±»ä»cookieæ‹¿å‡ºæ¥çš„å€¼ï¼‰ã€‚è§£å†³æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-typescript">// types/ts

interface IEffectConfigAugmentedReq {
  // ä½¿ç”¨Partialæ˜¯å› ä¸ºç›´åˆ°promiseè¿”å›ä»¥åæ‰æœ‰å†…å®¹ï¼Œæ‰€ä»¥å¯èƒ½æ˜¯ç©ºï¼ˆè™½ç„¶è¿™é‡Œæ˜¯awaitï¼Œä½†æ— ä¼¤å¤§é›…ï¼‰
    effectConfigs: Partial&lt;IEffectConfigs&gt;
}

export interface IListPageAugmentedReq {
    dim?: string;
}

---

// route.ts

// æŒ‡ä»¤å¤„ç†
    // å¸¦ä¸Šï¼šIEffectConfigAugmentedReq
    router.get(['/n-1/instruction/process'], async (ctx) =&gt; {
        let fetchRes = await fetch.get(&quot;fgcdBasicCenterCommonApi.getConfig&quot;, {}, ctx);
        ctx.req.effectConfigs = fetchRes &amp;&amp; fetchRes.data;
        await app.render(ctx.req, ctx.res, '/instruction/process', ctx.query);
    });

    // å¸¸ç”¨å·¥å…·-æ•°æ®å¤„ç†
    // å¸¦ä¸Šï¼šIListPageAugmentedReq
    router.get(['/n-1/tools/data-handle'], async (ctx) =&gt; {
        const queryDim = ctx.query.dim as string;
        ctx.req.dim = dataHandleDims.includes(queryDim) ? queryDim : 'urlHandle';
        await app.render(ctx.req, ctx.res, '/tools/data-handle', ctx.query);
    });
</code></pre>
<p>è¿™æ ·åœ¨pageçš„é¡µé¢é‡Œå¸¦ä¸Šéœ€è¦çš„æ³›å‹ï¼Œå°±å¯ä»¥æ­£ç¡®è¯†åˆ«åœ¨ctxä¸Šå¢åŠ çš„å€¼äº†</p>
<h5 id="ssr">SSR</h5>
<p>å…¶å®æ–°ç‰ˆæœ¬çš„Nextå·²ç»æŠŠgetInitialPropsè¿™ä¸ªæ ¹æ®ctxå’Œéœ€æ±‚æ¥æŒ‡å®šé¡µé¢ç»„ä»¶å‚æ•°çš„å‡½æ•°æ‹†åˆ†æˆäº†ä¿©ï¼š</p>
<ul>
<li>getStaticProps (Static Generation) : Next.js will pre-render this page at build time using the props returned by <code>getStaticProps</code>.</li>
<li>getServerSideProps (SSR) : Next.js will pre-render this page on each request using the data returned by <code>getServerSideProps</code>.</li>
</ul>
<p>è¿™æ ·å°±å¯ä»¥åˆ†ç¦»é™æ€é¡µé¢å’ŒåŠ¨æ€é¡µé¢ï¼Œå‡å°‘ä¸å¿…è¦çš„æœåŠ¡å™¨è®¡ç®—ã€‚</p>
<p>ä½†è€ƒè™‘åˆ°ä¿¡å®‰è¿™ç§ä¸­å°çš„é¡µé¢éƒ½æ˜¯æ ¹æ®ä¸åŒçš„è´¦å·æ¥æ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼Œç„¶åæ¯æ¬¡æ˜¾ç¤ºä¹Ÿéƒ½æ˜¯å»æ‹‰æœ€æ–°çš„æ•°æ®ï¼Œä¸ºäº†å°½å¯èƒ½ä¸æ”¹æ¶æ„ï¼Œæˆ‘è¿˜æ˜¯é€‰ç”¨äº†åŸæ¥çš„getInitialProp() è¿™ç§æ–¹å¼ã€‚</p>
<p>ç°åœ¨ ä¸ºäº†å®ç°æ–¹ä¾¿çš„è‡ªåŠ¨ç±»å‹æ¨å¯¼ï¼Œåœ¨/pages/ä¸‹é¢çš„tsé¡µé¢éƒ½å¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼æ¥å®ç°SSRï¼š</p>
<pre><code class="language-typescript">// getInitialPropsä¼šæ¥å—çš„å‚æ•°ï¼Œè¿™é‡Œåº”è¯¥æ˜¯Koa ContextåŠ ä¸Šæ­¤é¡µé¢åœ¨è·¯ç”±çš„æ—¶å€™æ·»åŠ çš„ctxå†…å®¹
type CustomizedContext = AugmentedKoaContext &amp; Context that are added while routing;

// å•ç‹¬å†™ä¸€ä¸ªGetInitialPropsæ–¹æ³•ï¼Œç„¶åæŠŠå…¥å‚è§„å®šä¸ºåˆšå®šä¹‰çš„ç»„åˆç±»å‹
async function GetInitialProps({req, res}: CustomizedContext) {
    return {
        loginUser: req.loginUser,
        siderBarCollapsed: res.siderBarCollapsed
      	anything...
    };
}

/*
    å–åˆ°getInitialPropsè¿”å›çš„ç±»å‹ä½œä¸ºæ­¤ç»„ä»¶çš„Props
    å› ä¸ºGetIntialPropså®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ªPromiseï¼Œæ‰€ä»¥å¾—åˆ°ä»–çš„è¿”å›ç±»å‹ä»¥åè¿˜è¦unbox
    è¿™ä¸ªReturnTypeUnboxPromise&lt;T&gt;å®šä¹‰åœ¨äº†lib/utils/nextType.tsä¸­
*/
type Props = ReturnTypeUnboxPromise&lt;typeof GetInitialProps&gt;;

/*
   ç”±Nextæ¸²æŸ“çš„é¡µé¢ç»„ä»¶éœ€å£°æ˜ä¸ºNextComponentType&lt;C,IP,P&gt;ç±»å‹
   å…¶ä¸­Cä¸ºè‡ªå®šä¹‰çš„Contextï¼Œè¿™é‡Œè®¾æˆKoaä¸­é—´ä»¶åŠ ä¸Šè·¯ç”±ç»„åˆèµ·æ¥çš„CustomizedContext
   IPä¸ºInitial Propsï¼Œè¿™é‡Œä¸ç”¨ç®¡å®ƒ
   Pä¸ºPropsï¼Œä¹Ÿå°±æ˜¯ä½ è‡ªå®šä¹‰çš„è¿™ä¸ªç»„ä»¶åº”è¯¥æ¥å—çš„å‚æ•°åˆ—è¡¨ï¼Œè¿™é‡Œè®¾æˆgetInitialPropsçš„è¿”å›å€¼çš„ç±»å‹
   è¿™ä¸ªæ—¶å€™tså°±èƒ½è‡ªåŠ¨ä¸ºä½ æ¨æ–­å‡ºpropsçš„ç±»å‹
*/
const YourPage: NextComponentType&lt;CustomizedContext, {}, Props&gt; = (props) =&gt; {
  return &lt;p&gt;You can get {props.loginUser} here&lt;p/&gt;
}

export default YourPage;
</code></pre>
<p>è™½ç„¶çœ‹èµ·æ¥æœ‰ç‚¹éº»çƒ¦ï¼Œç›¸æ¯”è·å¾—çš„è‡ªåŠ¨æ¨å¯¼ç±»å‹è¿™ä¸ªå¥½å¤„æ¥è¯´è¿˜æ˜¯å€¼å¾—çš„ã€‚</p>
<h3 id="jquery-plugin">JQuery Plugin</h3>
<p>å› ä¸ºæˆ‘ä»¬çš„JQueryå’Œç›¸å…³çš„æ’ä»¶éƒ½æ˜¯ç”¨commonJSçš„æ–¹å¼å¼•å…¥çš„ï¼Œå› æ­¤ä¼šå‡ºç°â€œTSä¸çŸ¥é“$.toastæ˜¯ä¸€ä¸ªæ–¹æ³•â€è¿™ç§é—®é¢˜ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦ç»™å®ƒå•ç‹¬å†™d.tsæ¥å¢å¼ºJQueryStaticè¿™ä¸ªinterfaceã€‚</p>
<p>jquery-plugin.d.ts</p>
<pre><code class="language-typescript">/// &lt;reference types=&quot;jquery&quot;/&gt;
interface JQueryStatic {
    toast: (text: string) =&gt; void
}
</code></pre>
<p>(ä¾‹å¦‚ï¼šæŠŠ <code>/// &lt;reference tyoes=&quot;node&quot; /&gt;</code> å¼•å…¥åˆ°å£°æ˜æ–‡ä»¶ï¼Œè¡¨æ˜è¿™ä¸ªæ–‡ä»¶ä½¿ç”¨äº† <code>@types/node/index.d.ts</code> é‡Œé¢å£°æ˜çš„åå­—ï¼Œå¹¶ä¸”ï¼Œè¿™ä¸ªåŒ…éœ€è¦åœ¨ç¼–è¯‘é˜¶æ®µä¸å£°æ˜æ–‡ä»¶ä¸€èµ·è¢«åŒ…å«è¿›æ¥ã€‚)</p>
<p>ç„¶ååœ¨tsconfigé‡Œé¢æ³¨å†Œå®ƒ</p>
<pre><code class="language-json">    &quot;types&quot;: [
      &quot;./lib/utils/jquery-plugin&quot;,
      &quot;./lib/utils/dt-report-trigger&quot;,
      &quot;./lib/utils/global&quot;
    ]
</code></pre>
<p>æˆ‘ä»¬å¤šde-report-triggerå’ŒNodeJS.Process.browserä¹ŸåŒæ ·ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•æ¥æ³¨å†Œã€‚</p>
<h3 id="ant-design-with-typescript">Ant Design with TypeScript</h3>
<h5 id="form-integrate-with-table">Form integrate with Table</h5>
<p>å¤§éƒ¨åˆ†çš„æ•°æ®é¡µé¢éƒ½æ˜¯ä¸Šé¢ä¸ºç­›é€‰æ¡†ï¼Œä¸‹é¢æ˜¯è¡¨æ ¼ã€‚ä¸€èˆ¬çš„ç­›é€‰æ¡†ä¸»è¦æœ‰ä¸¤ä¸ªäº‹ä»¶ï¼š<strong>ç­›é€‰å†…å®¹æ›´æ”¹(queryChange)</strong> å’Œ <strong>ç”¨æˆ·ç‚¹å‡»æŸ¥è¯¢(seach)</strong>ã€‚Tableç»„ä»¶é€šè¿‡ä½¿ç”¨forwardRefæ¥æš´éœ²queryChangeåŠsearchä¸¤ä¸ªæ–¹æ³•ç»™ä¸»é¡µé¢ã€‚è¿™æ ·ä¸»é¡µé¢ä¼ ç»™ç­›é€‰æ¡†å›è°ƒå‡½æ•°ï¼Œäº‹ä»¶å‘ç”Ÿä»¥åä¸»é¡µé¢æ”¶åˆ°å›è°ƒå“åº”ä»¥åæŠŠå†é€šè¿‡è°ƒç”¨Tableæš´éœ²çš„æ–¹æ³•ä¼ é€’å†…å®¹äº¤ç»™Tableç»„ä»¶è¿›è¡ŒæŸ¥è¯¢å’Œæ˜¾ç¤ºã€‚</p>
<p>table.tsx</p>
<pre><code class="language-typescript">// æš´éœ²ç»™çˆ¶çº§çš„æ–¹æ³•
export interface DataTableExposedMethods {
    search: (data?: IFetchParams, num?: number) =&gt; void
    changeWithQueries: (data: IFetchParams) =&gt; void
}

// Tableç»„ä»¶æœ¬èº«åº”è¯¥æ¥å—çš„å‚æ•°
export interface IDataTableProps {
    fetchParams: IFetchParams,
    anything...
}

/*
    è¿™é‡Œç”¨ForwardRefRenderFunction&lt;T,P&gt;å£°æ˜Tableç»„ä»¶ç±»å‹å› ä¸ºè¿™ä¸ªæ˜¯ä¸»é¡µé¢forwardRefè¦æ¥å—çš„ç±»å‹
    å…¶ä¸­Tä¸ºæš´éœ²ç»™çˆ¶çº§çš„æ–¹æ³•
    Pä¸ºæœ¬ç»„ä»¶åº”è¯¥æ¥å—çš„å‚æ•°ç±»å‹
 */
const DataTable: ForwardRefRenderFunction&lt;DataTableExposedMethods, IDataTableProps&gt; = (props, ref) =&gt; {
    // æš´éœ²ç»™çˆ¶çº§çš„æ–¹æ³•ï¼Œç”¨useImperativeHandleåŒ…è£…
  	// åé¢ç”¨ as DataTableExposedMethodsè¿™æ ·tså°±èƒ½å¸®ä½ æ¨æ–­æ¯”å¦‚è¯´searchçš„å‚æ•°sã€nçš„ç±»å‹
    useImperativeHandle(ref, () =&gt; ({
        search: (s, n = 1) =&gt; {
            setPageNo(n);
            fetchData(s, n);
        },
        changeWithQueries: (s) =&gt; {
            setFetchParams(s);
        }
    } as DataTableExposedMethods));

    return &lt;Table .../&gt;;
}

export default DataTable;
</code></pre>
<p>page.tsx</p>
<pre><code class="language-typescript">/*
  forwardRefç¬¬ä¸€ä¸ªæ˜¯refçš„ç±»å‹ï¼Œç¬¬äºŒä¸ªæ˜¯è¿™ä¸ªrefçš„propsçš„ç±»å‹
  è¿™é‡Œå› ä¸ºåœ¨DataTableRé‡Œå·²ç»å®šä¹‰äº†ç»„ä»¶ç±»å‹ä¸ºForwardRefRenderFunction&lt;DataTableMethods, IDataTableProps&gt;
  æ‰€ä»¥forwardRefä¼šè‡ªåŠ¨æ¨æ–­å‡ºè¿™ä¿©æ³›å‹
*/
let DataTable = forwardRef(DataTableR);

const YourPage: NextComponentType&lt;CustomizedContext, {}, Props&gt; = (props) =&gt; {
  
  	// éœ€è¦å¾—åˆ°tableå®ä¾‹çš„å¼•ç”¨
    // ä¼ å…¥çš„æ³›å‹ä¸ºæš´éœ²ç»™çˆ¶ç»„ä»¶ï¼ˆæ­¤ç»„ä»¶ï¼‰çš„æ–¹æ³•
    let dataTable = useRef&lt;DataTableExposedMethods&gt;(null);

    // searchï¼šç­›é€‰å­ç»„ä»¶è°ƒç”¨çˆ¶ç»„ä»¶searchæ–¹æ³•ï¼Œsearchæ–¹æ³•å»è°ƒç”¨è¡¨æ ¼å­ç»„ä»¶çš„è·å–æ•°æ®æ–¹æ³•ï¼Œè¯¥é¡¹ç›®ç»Ÿä¸€ä¸ºæŸ¥è¯¢æŒ‰é’®äº‹ä»¶
    // queryChangeï¼šç­›é€‰å­ç»„ä»¶å‚æ•°å˜åŒ–åŒæ­¥åˆ°æ•°æ®æ¸²æŸ“å­ç»„ä»¶
    const search = dataTable.current!.search
    const queryChange = dataTable.current!.changeWithQueries;

    return (
      &lt;FilterForm
         fetchParams={fetchParams}
         onSubmit={search}
         onQueryChange={queryChange}
			/&gt;
      &lt;DataTable
         ref={dataTable}
			/&gt; 
    );
}

export default YourPage;
</code></pre>
<p>å½“ç„¶ï¼Œè¿™ä¸ªåªæ˜¯ä¸€ä¸ªç®€å•çš„demoï¼Œä¿¡å®‰è¿™ä¸ªé¡¹ç›®è¿˜ç”¨äº†æ›´æŠ½è±¡çš„å®ç°ï¼Œæ¯”å¦‚æå–useImperativeHandleè¿™ä¸€æ®µåˆ°å•ç‹¬çš„useFetchListData hooksä¸­ä¾¿äºå¤ç”¨ç­‰ã€‚</p>
<p>è¿˜æ²¡å†™å®Œ åˆ«å‚¬ å¿«äº†</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6">ä¸­é—´ä»¶</a></li>
<li><a href="#next-koa">Next &amp; Koa</a>
<ul>
<li><a href="#%E7%89%88%E6%9C%AC">ç‰ˆæœ¬</a></li>
<li><a href="#dev">dev</a></li>
<li><a href="#before-render">Before Render</a></li>
<li><a href="#ssr">SSR</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jquery-plugin">JQuery Plugin</a></li>
<li><a href="#ant-design-with-typescript">Ant Design with TypeScript</a><br>
*
<ul>
<li><a href="#form-integrate-with-table">Form integrate with Table</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://kaby-lake.github.io/post/qing-xie-zhao-xin-tui-wen-mu-hou/">
              <h3 class="post-title">
                é’åæ‹›æ–°æ¨æ–‡å¹•å
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://kaby-lake.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
